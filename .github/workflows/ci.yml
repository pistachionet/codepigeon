# This is the name that shows up in the Actions tab on GitHub
name: CI

# When should this workflow run?
# "on" defines the triggers
on:
  # Run when code is pushed to these branches
  push:
    branches: [ main, v_1, feature/pipeline-setup ]

  # Also run when someone opens a Pull Request to these branches
  pull_request:
    branches: [ main, v_1 ]

# What work should be done?
# "jobs" contains one or more jobs that run
jobs:

  # This is our first job, we'll call it "test"
  test:
    # Give it a friendly name that shows in GitHub UI
    name: Test and Build

    # What computer should run this?
    # ubuntu-latest = Linux machine provided by GitHub (free!)
    runs-on: ubuntu-latest

    # The actual work! "steps" are executed in order
    steps:
      # Step 1: Check out our code
      # Without this, the machine wouldn't have our code!
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Go on this machine
      # The Ubuntu machine doesn't have Go installed by default
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          # Tell it which Go version we want (matching your project)
          go-version: '1.23'
          # This enables caching of downloaded Go modules (faster!)
          cache: true

      # Step 3: Download our project dependencies
      # This runs "go mod download" to get all the packages we need
      - name: Download dependencies
        run: go mod download

      # Step 4: Run our tests
      # This uses your Makefile's test command
      - name: Run tests
        run: make test

      # Step 5: Build the binary
      # This creates the actual codedoc executable
      - name: Build
        run: make build

      # Step 6: Verify the binary works
      # Make sure our build created a working executable
      - name: Test binary
        run: |
          echo "Checking if binary exists..."
          test -f build/codedoc
          echo "Binary found! Testing if it runs..."
          ./build/codedoc --help