#!/bin/sh
# Pre-commit hook for Go projects using gofumpt
# Install: make hooks
# Required: go install mvdan.cc/gofumpt@latest

set -e

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    if [ $1 -eq 0 ]; then
        echo "${GREEN}‚úì${NC} $2"
    else
        echo "${RED}‚úó${NC} $2"
        exit 1
    fi
}

# 1. Check if gofumpt is installed
if ! command -v gofumpt &> /dev/null; then
    echo "${YELLOW}‚ö†Ô∏è  gofumpt is not installed${NC}"
    echo "${BLUE}Installing gofumpt...${NC}"
    go install mvdan.cc/gofumpt@latest
    if [ $? -ne 0 ]; then
        echo "${RED}Failed to install gofumpt${NC}"
        echo "Please install manually: go install mvdan.cc/gofumpt@latest"
        exit 1
    fi
fi

# 2. Check for formatting issues with gofumpt
echo "üìù Checking code formatting with gofumpt..."
UNFORMATTED=$(gofumpt -l .)
if [ -n "$UNFORMATTED" ]; then
    echo "${RED}‚úó${NC} The following files need formatting with gofumpt:"
    echo "$UNFORMATTED" | while read -r file; do
        echo "  ${YELLOW}$file${NC}"
    done
    echo ""
    echo "${BLUE}To fix all files:${NC}"
    echo "  gofumpt -w ."
    echo ""
    echo "${BLUE}To fix specific files:${NC}"
    echo "  gofumpt -w <filename>"
    echo ""
    echo "${BLUE}To see the diff:${NC}"
    echo "  gofumpt -d ."
    exit 1
else
    echo "${GREEN}‚úì${NC} Code formatting OK (gofumpt)"
fi

# 3. Run go vet for basic issues
echo "üîé Running go vet..."
go vet ./... 2>/dev/null
print_status $? "go vet passed"

# 4. Run staticcheck if available (optional but recommended)
if command -v staticcheck &> /dev/null; then
    echo "üî¨ Running staticcheck..."
    if staticcheck ./... 2>&1 | grep -q "module requires at least go"; then
        echo "${YELLOW}‚ö†Ô∏è  Skipping staticcheck (Go version mismatch)${NC}"
    else
        staticcheck ./... 2>/dev/null
        print_status $? "staticcheck passed"
    fi
fi

# 5. Run go mod tidy and check for changes
echo "üì¶ Checking go.mod..."
cp go.mod go.mod.backup
cp go.sum go.sum.backup 2>/dev/null || true
go mod tidy
if ! diff -q go.mod go.mod.backup >/dev/null 2>&1; then
    mv go.mod.backup go.mod
    mv go.sum.backup go.sum 2>/dev/null || true
    echo "${RED}‚úó${NC} go.mod is not tidy"
    echo "${YELLOW}Run 'go mod tidy' to fix${NC}"
    exit 1
else
    rm go.mod.backup
    rm go.sum.backup 2>/dev/null || true
    echo "${GREEN}‚úì${NC} go.mod is tidy"
fi

# 6. Check for build errors
echo "üî® Checking build..."
go build -o /dev/null ./cmd/codedoc 2>/dev/null
print_status $? "Build successful"

# 7. Optional: Run fast tests (uncomment if desired)
# echo "üß™ Running fast tests..."
# go test -short -race ./...
# print_status $? "Tests passed"

echo ""
echo "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
echo "${BLUE}Tip: gofumpt enforces stricter formatting than gofmt${NC}"